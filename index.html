<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸»é¡µ - AI å¢å¼ºç‰ˆ</title>
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨ï¼šæ‹Ÿæ€é£æ ¼ (Neumorphism)
           ========================================= */
        :root {
            --bg-color: #e0e5ec;
            --text-main: #4a4a4a;
            --text-sub: #8d97a5;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --accent-color: #6d5dfc;
            --card-radius: 30px;
            --transition: all 0.4s ease;
        }

        [data-theme="dark"] {
            --bg-color: #292d3e;
            --text-main: #e0e6ed;
            --text-sub: #a0a7b5;
            --shadow-light: #3e445e;
            --shadow-dark: #1b1e2a;
            --accent-color: #2196f3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: var(--transition); overflow-x: hidden; padding: 20px; }
        
        /* æ ¸å¿ƒå®¹å™¨ */
        .container { width: 100%; max-width: 420px; background-color: var(--bg-color); border-radius: var(--card-radius); box-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light); padding: 40px 30px; display: flex; flex-direction: column; align-items: center; position: relative; transition: var(--transition); }
        
        /* é¡¶éƒ¨æ  */
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .clock { font-size: 0.9rem; color: var(--text-sub); font-weight: 500; letter-spacing: 1px; }
        .theme-toggle { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--text-sub); cursor: pointer; background-color: var(--bg-color); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); transition: var(--transition); }
        .theme-toggle:active { box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); color: var(--accent-color); }
        
        /* å¤´åƒ */
        .avatar-box { width: 140px; height: 140px; border-radius: 50%; padding: 8px; background-color: var(--bg-color); box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); margin-bottom: 25px; position: relative; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--bg-color); }
        .status-dot { position: absolute; bottom: 10px; right: 10px; width: 18px; height: 18px; background-color: #00e676; border-radius: 50%; border: 3px solid var(--bg-color); box-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        
        /* ä¿¡æ¯åŒº */
        .info { text-align: center; width: 100%; }
        .name { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
        .bio { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 30px; height: 24px; display: flex; justify-content: center; align-items: center; }
        .cursor { display: inline-block; width: 2px; height: 1.2em; background-color: var(--accent-color); margin-left: 2px; animation: blink 1s infinite; }
        
        /* æŒ‰é’®ç½‘æ ¼ */
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; margin-bottom: 30px; }
        .neumorphic-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90px; border-radius: 15px; color: var(--text-sub); text-decoration: none; background-color: var(--bg-color); box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light); transition: var(--transition); position: relative; overflow: hidden; border: none; outline: none; cursor: pointer; }
        .neumorphic-btn i { font-size: 1.5rem; margin-bottom: 8px; transition: transform 0.3s; }
        .neumorphic-btn span { font-size: 0.8rem; font-weight: 500; }
        .neumorphic-btn:hover { transform: translateY(-2px); color: var(--accent-color); }
        .neumorphic-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: translateY(0); }
        
        /* é•¿æŒ‰é’® */
        .wide-actions { width: 100%; display: flex; flex-direction: column; gap: 20px; }
        .wide-btn { display: flex; align-items: center; justify-content: space-between; padding: 18px 25px; border-radius: 15px; color: var(--text-main); text-decoration: none; background-color: var(--bg-color); box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light); transition: var(--transition); cursor: pointer; border: none; }
        .wide-btn:hover { color: var(--accent-color); transform: translateX(5px); }
        .wide-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: translateX(0); }
        .wide-btn-icon { display: flex; align-items: center; gap: 15px; }
        .wide-btn-icon i { width: 30px; text-align: center; }
        
        /* æ¨¡æ€æ¡† (AI èŠå¤©) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { width: 90%; max-width: 400px; height: 80vh; max-height: 600px; background-color: var(--bg-color); border-radius: var(--card-radius); box-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light); display: flex; flex-direction: column; padding: 20px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .modal-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .modal-controls { display: flex; gap: 10px; }
        
        /* å°å›¾æ ‡æŒ‰é’® */
        .icon-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-sub); box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light); transition: all 0.2s; }
        .icon-btn:active { box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light); }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel { position: absolute; top: 60px; left: 20px; right: 20px; background: var(--bg-color); padding: 20px; border-radius: 15px; box-shadow: 5px 5px 15px var(--shadow-dark), -5px -5px 15px var(--shadow-light); z-index: 10; display: none; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
        .settings-panel.show { display: block; opacity: 1; transform: translateY(0); }
        .settings-group { margin-bottom: 15px; }
        .settings-label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-sub); font-weight: bold; }
        .settings-input, .settings-select { width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--bg-color); box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); color: var(--text-main); font-family: inherit; outline: none; }
        .save-btn { width: 100%; padding: 10px; border-radius: 10px; background: var(--accent-color); color: #fff; border: none; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 6px rgba(0,0,0,0.2); transition: all 0.2s; }
        .save-btn:active { transform: scale(0.98); }

        /* èŠå¤©åŒºåŸŸ */
        .chat-box { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; scrollbar-width: thin; }
        .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .chat-message.ai { align-self: flex-start; background-color: var(--bg-color); color: var(--text-main); border-bottom-left-radius: 2px; box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); }
        .chat-message.user { align-self: flex-end; background-color: var(--accent-color); color: #fff; border-bottom-right-radius: 2px; box-shadow: 3px 3px 8px rgba(0,0,0,0.2); }
        .chat-message.system { align-self: center; background-color: transparent; color: var(--text-sub); font-size: 0.8rem; box-shadow: none; text-align: center; max-width: 100%; }
        
        /* èŠå¤©å›¾ç‰‡æ ·å¼ */
        .chat-image { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area { display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 15px; border-radius: 25px; border: none; background-color: var(--bg-color); color: var(--text-main); box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); outline: none; }
        
        .action-btn { width: 45px; height: 45px; border-radius: 50%; background-color: var(--bg-color); color: var(--text-sub); display: flex; justify-content: center; align-items: center; cursor: pointer; border: none; box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light); transition: all 0.2s ease; }
        .action-btn:active { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); transform: scale(0.95); }
        .action-btn.send { color: var(--accent-color); }

        /* å›¾ç‰‡é¢„è§ˆåŒº */
        .file-preview-area {
            display: none;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 15px;
            margin-bottom: 10px;
            position: relative;
            box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
        }
        .file-preview-img { height: 60px; border-radius: 8px; border: 2px solid var(--bg-color); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .remove-file-btn { position: absolute; top: 5px; left: 65px; background: #ff5252; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 5px 10px; }
        .typing-dot { width: 6px; height: 6px; background-color: var(--text-sub); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .footer { margin-top: 40px; font-size: 0.75rem; color: var(--text-sub); opacity: 0.7; }
        
        @media (max-width: 380px) { .container { padding: 30px 20px; } .action-grid { gap: 15px; } .neumorphic-btn { height: 80px; } }
    </style>
</head>
<body>

    <div class="container">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="top-bar">
            <div class="clock" id="clock">00:00</div>
            <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </div>
        </div>

        <!-- å¤´åƒåŒº -->
        <div class="avatar-box">
            <!-- è‡ªåŠ¨è·å–QQå¤´åƒ -->
            <img src="https://q1.qlogo.cn/g?b=qq&nk=2433993490&s=640" alt="User Avatar" onerror="this.src='https://via.placeholder.com/150'">
            <div class="status-dot"></div>
        </div>

        <!-- ä¸ªäººä¿¡æ¯ -->
        <div class="info">
            <h1 class="name">ä½ å¥½, æˆ‘æ˜¯ jjj</h1>
            <div class="bio">
                <span id="typing-text"></span><span class="cursor"></span>
            </div>
        </div>

        <!-- å¿«æ·å…¥å£ -->
        <div class="action-grid">
            <a href="https://github.com/2433993490/zhuye" target="_blank" class="neumorphic-btn">
                <i class="fab fa-github"></i>
                <span>GitHub</span>
            </a>
            <button onclick="copyWechat()" class="neumorphic-btn">
                <i class="fab fa-weixin"></i>
                <span>å¾®ä¿¡</span>
            </button>
            <button onclick="handleQQClick()" class="neumorphic-btn">
                <i class="fab fa-qq"></i>
                <span>QQ</span>
            </button>
            <button onclick="copyEmail()" class="neumorphic-btn">
                <i class="fas fa-envelope"></i>
                <span>é‚®ä»¶</span>
            </button>
        </div>

        <!-- åŠŸèƒ½åˆ—è¡¨ -->
        <div class="wide-actions">
            <!-- âœ¨ AI åŠ©æ‰‹å…¥å£ âœ¨ -->
            <button onclick="openAIModal()" class="wide-btn" style="border: 2px solid transparent; background-clip: padding-box;">
                <div class="wide-btn-icon">
                    <i class="fas fa-robot" style="color: var(--accent-color);"></i>
                    <span style="font-weight: bold;">âœ¨ å¬å”¤ AI åŠ©æ‰‹</span>
                </div>
                <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
            </button>

            <a href="https://github.com?tab=repositories" target="_blank" class="wide-btn">
                <div class="wide-btn-icon">
                    <i class="fas fa-laptop-code"></i>
                    <span>æˆ‘çš„é¡¹ç›®</span>
                </div>
                <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
            </a>
            
            <a href="https://www.jjj.ad" target="_blank" class="wide-btn">
                <div class="wide-btn-icon">
                    <i class="fas fa-pen-nib"></i>
                    <span>åšå®¢æ–‡ç« </span>
                </div>
                <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
            </a>

            <a href="https://www.emby.su" target="_blank" class="wide-btn">
                <div class="wide-btn-icon">
                    <i class="fas fa-film"></i>
                    <span>Emby</span>
                </div>
                <i class="fas fa-play" style="font-size: 0.7rem;"></i>
            </a>
        </div>

        <div class="footer">
            Â© 2025 ä¸ªäººä¸»é¡µ
        </div>
    </div>

    <!-- AI èŠå¤©æ¨¡æ€æ¡† -->
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sparkles" style="color: var(--accent-color);"></i>
                    jjj çš„ AI åˆ†èº«
                </div>
                <div class="modal-controls">
                    <!-- è®¾ç½®æŒ‰é’® -->
                    <div class="icon-btn" onclick="toggleSettings()" title="è®¾ç½® API">
                        <i class="fas fa-cog"></i>
                    </div>
                    <!-- å…³é—­æŒ‰é’® -->
                    <div class="icon-btn" onclick="closeAIModal()" title="å…³é—­">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            </div>
            
            <!-- è®¾ç½®é¢æ¿ (é»˜è®¤éšè—) -->
            <div id="settingsPanel" class="settings-panel">
                <div class="settings-group">
                    <label class="settings-label">è¿æ¥æ¨¡å¼</label>
                    <select id="modeSelect" class="settings-select" onchange="handleModeChange()">
                        <option value="default">ğŸ”— é»˜è®¤çº¿è·¯ (ç«™é•¿æä¾›/å…è´¹)</option>
                        <option value="custom">ğŸ”‘ è‡ªå®šä¹‰ API (ä½¿ç”¨è‡ªå·±çš„ Key)</option>
                    </select>
                </div>

                <!-- è‡ªå®šä¹‰é…ç½®åŒºåŸŸ (ä»…è‡ªå®šä¹‰æ¨¡å¼æ˜¾ç¤º) -->
                <div id="customConfigArea" style="display: none;">
                    <div class="settings-group">
                        <label class="settings-label">æœåŠ¡å•†å¿«æ·é¢„è®¾</label>
                        <select id="providerPreset" class="settings-select" onchange="applyPreset()">
                            <option value="deepseek">DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                            <option value="openai">OpenAI (GPT-3.5/4)</option>
                            <option value="kimi">Kimi (æœˆä¹‹æš—é¢)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="custom">æ‰‹åŠ¨è¾“å…¥...</option>
                        </select>
                    </div>

                    <div class="settings-group">
                        <label class="settings-label">API æ¥å£åœ°å€ (Base URL)</label>
                        <input type="text" id="baseUrlInput" class="settings-input" placeholder="ä¾‹å¦‚ https://api.deepseek.com">
                    </div>

                    <div class="settings-group">
                        <label class="settings-label">API å¯†é’¥ (Key)</label>
                        <input type="password" id="apiKeyInput" class="settings-input" placeholder="sk-xxxxxxxx">
                    </div>

                    <div class="settings-group">
                        <label class="settings-label">æ¨¡å‹åç§° (Model)</label>
                        <input type="text" id="modelInput" class="settings-input" placeholder="deepseek-chat">
                    </div>
                </div>

                <button class="save-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
            
            <div id="chatBox" class="chat-box">
                <div class="chat-message ai">
                    ä½ å¥½å‘€ï¼æˆ‘æ˜¯ jjj çš„ AI æ•°å­—åˆ†èº«ã€‚âœ¨<br>
                    éšä¾¿èŠèŠå§ï¼<br>
                    (å¦‚éœ€å‘é€å›¾ç‰‡ï¼Œè¯·ç‚¹å‡»å·¦ä¸‹è§’ğŸ“å›¾æ ‡)
                </div>
            </div>

            <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
            <div id="filePreview" class="file-preview-area">
                <img id="previewImg" class="file-preview-img" src="" alt="é¢„è§ˆ">
                <div class="remove-file-btn" onclick="clearFileSelection()">Ã—</div>
            </div>

            <!-- åº•éƒ¨è¾“å…¥æ  -->
            <div class="chat-input-area">
                <!-- æ–‡ä»¶é€‰æ‹©æŒ‰é’® -->
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect()">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ å›¾ç‰‡">
                    <i class="fas fa-paperclip"></i>
                </button>

                <input type="text" id="userInput" class="chat-input" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="handleEnter(event)">
                
                <button class="action-btn send" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš™ï¸ åå°æ¥å£åœ°å€ (é»˜è®¤ PHP ä»£ç†)
        // ==========================================
        const DEFAULT_API_ENDPOINT = "./chat.php"; 

        // 1. æ—¶é’ŸåŠŸèƒ½
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const toggleBtn = document.getElementById('themeToggle');
            const icon = toggleBtn.querySelector('i');
            const isDark = body.getAttribute('data-theme') === 'dark';
            if (isDark) {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
            }
        }

        // 3. è¾…åŠ©åŠŸèƒ½ (å¤åˆ¶ & è·³è½¬)
        function copyToClipboard(text, type) {
            const tempInput = document.createElement("input");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            tempInput.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert(`${type} ${text} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`);
            } catch (err) {
                alert(`å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ${text}`);
            }
            document.body.removeChild(tempInput);
        }
        function copyEmail() { copyToClipboard("admin@jjj.ad", "é‚®ç®±"); }
        function copyWechat() { copyToClipboard("q2433993490", "å¾®ä¿¡å·"); }
        function handleQQClick() {
            const qq = "2433993490";
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                window.location.href = `mqqwpa://im/chat?chat_type=wpa&uin=${qq}&version=1&src_type=web`;
                setTimeout(() => alert("å¦‚æœæœªè‡ªåŠ¨è·³è½¬ï¼Œè¯·å°è¯•æ‰‹åŠ¨æ·»åŠ QQ: " + qq), 2000);
            } else {
                window.location.href = `tencent://message/?uin=${qq}&Site=Sambow&Menu=yes`;
            }
        }

        // 4. æ‰“å­—æœºæ•ˆæœ
        const texts = ["å¸¸è®°æºªäº­æ—¥æš®ï¼Œæ²‰é†‰ä¸çŸ¥å½’è·¯ã€‚", "å…´å°½æ™šå›èˆŸï¼Œè¯¯å…¥è—•èŠ±æ·±å¤„ã€‚", "äº‰æ¸¡ï¼Œäº‰æ¸¡ï¼ŒæƒŠèµ·ä¸€æ»©é¸¥é¹­ã€‚", "æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸»é¡µ"];
        let count = 0;
        let index = 0;
        let currentText = "";
        let letter = "";
        (function type() {
            if (count === texts.length) { count = 0; }
            currentText = texts[count];
            letter = currentText.slice(0, ++index);
            document.getElementById('typing-text').textContent = letter;
            if (letter.length === currentText.length) {
                setTimeout(() => { count++; index = 0; setTimeout(type, 2000); }, 100);
            } else {
                setTimeout(type, 150);
            }
        })();

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            toggleTheme();
        }

        // ==========================================
        // âœ¨ AI èŠå¤©é€»è¾‘ (æ”¯æŒ Default Proxy, Custom API å’Œ å›¾ç‰‡ä¸Šä¼ )
        // ==========================================
        const modal = document.getElementById('aiModal');
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const settingsPanel = document.getElementById('settingsPanel');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const previewImg = document.getElementById('previewImg');

        // ç”¨æˆ·é…ç½®çŠ¶æ€
        let userConfig = {
            mode: 'default', // default | custom
            provider: 'deepseek',
            baseUrl: '',
            apiKey: '',
            model: ''
        };

        // å½“å‰é€‰ä¸­çš„æ–‡ä»¶ Base64
        let currentFileBase64 = null;
        let currentFileMime = null;

        // é¢„è®¾é…ç½®æ•°æ®
        const PRESETS = {
            deepseek: { url: "https://api.deepseek.com", model: "deepseek-chat" }, // æ³¨æ„ï¼šDeepSeekå®˜æ–¹æš‚ä¸æ”¯æŒVision
            openai: { url: "https://api.openai.com/v1", model: "gpt-4o" },
            kimi: { url: "https://api.moonshot.cn/v1", model: "moonshot-v1-8k" },
            gemini: { url: "https://generativelanguage.googleapis.com", model: "gemini-1.5-flash" }
        };

        // åŠ è½½é…ç½®
        function loadSettings() {
            const saved = localStorage.getItem('ai_config_v2');
            if (saved) {
                userConfig = JSON.parse(saved);
            }
            
            // å¡«å…… UI
            document.getElementById('modeSelect').value = userConfig.mode;
            document.getElementById('providerPreset').value = userConfig.provider || 'custom';
            document.getElementById('baseUrlInput').value = userConfig.baseUrl || '';
            document.getElementById('apiKeyInput').value = userConfig.apiKey || '';
            document.getElementById('modelInput').value = userConfig.model || '';
            
            handleModeChange();
        }

        // ä¿å­˜é…ç½®
        function saveSettings() {
            userConfig.mode = document.getElementById('modeSelect').value;
            userConfig.provider = document.getElementById('providerPreset').value;
            userConfig.baseUrl = document.getElementById('baseUrlInput').value.replace(/\/$/, ''); // å»é™¤æœ«å°¾æ–œæ 
            userConfig.apiKey = document.getElementById('apiKeyInput').value.trim();
            userConfig.model = document.getElementById('modelInput').value.trim();

            localStorage.setItem('ai_config_v2', JSON.stringify(userConfig));
            toggleSettings();
            
            const modeText = userConfig.mode === 'default' ? "é»˜è®¤çº¿è·¯" : "è‡ªå®šä¹‰çº¿è·¯";
            addMessage(`é…ç½®å·²ä¿å­˜ï¼å½“å‰ä½¿ç”¨ï¼š${modeText}`, 'system');
        }

        // UI: åˆ‡æ¢é¢æ¿æ˜¾éš
        function toggleSettings() {
            settingsPanel.classList.toggle('show');
            if(settingsPanel.classList.contains('show')) {
                loadSettings();
            }
        }

        // UI: å¤„ç†æ¨¡å¼åˆ‡æ¢ (Default/Custom)
        function handleModeChange() {
            const mode = document.getElementById('modeSelect').value;
            const customArea = document.getElementById('customConfigArea');
            if (mode === 'custom') {
                customArea.style.display = 'block';
            } else {
                customArea.style.display = 'none';
            }
        }

        // UI: åº”ç”¨é¢„è®¾ (DeepSeek/OpenAI/etc)
        function applyPreset() {
            const provider = document.getElementById('providerPreset').value;
            if (PRESETS[provider]) {
                document.getElementById('baseUrlInput').value = PRESETS[provider].url;
                document.getElementById('modelInput').value = PRESETS[provider].model;
            }
        }

        function openAIModal() {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            userInput.focus();
            loadSettings(); // ç¡®ä¿åŠ è½½æœ€æ–°é…ç½®
        }

        function closeAIModal() {
            modal.classList.remove('show');
            settingsPanel.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeAIModal();
        });

        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        // --- æ–‡ä»¶å¤„ç†é€»è¾‘ ---
        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            // é™åˆ¶ä¸ºå›¾ç‰‡
            if (!file.type.startsWith('image/')) {
                alert("ç›®å‰ä»…æ”¯æŒä¸Šä¼ å›¾ç‰‡æ ¼å¼ (JPG, PNG, WebP)");
                fileInput.value = '';
                return;
            }

            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                currentFileBase64 = e.target.result; // data:image/jpeg;base64,...
                currentFileMime = file.type;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                previewImg.src = currentFileBase64;
                filePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearFileSelection() {
            fileInput.value = '';
            currentFileBase64 = null;
            currentFileMime = null;
            filePreview.style.display = 'none';
        }

        // --- æ¶ˆæ¯æ˜¾ç¤º ---
        function addMessage(text, sender, imageUrl = null) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender);
            
            let contentHtml = text.replace(/\n/g, '<br>');
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºåœ¨æ–‡æœ¬ä¸Šæ–¹
            if (imageUrl) {
                contentHtml = `<img src="${imageUrl}" class="chat-image"><br>` + contentHtml;
            }
            
            msgDiv.innerHTML = contentHtml;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showLoading() {
            const loader = document.createElement('div');
            loader.id = 'ai-loader';
            loader.classList.add('chat-message', 'ai');
            loader.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatBox.appendChild(loader);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeLoading() {
            const loader = document.getElementById('ai-loader');
            if (loader) loader.remove();
        }

        // ç³»ç»Ÿæç¤ºè¯
        const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ jjj ä¸ªäººä¸»é¡µä¸Šçš„ AI åŠ©æ‰‹ã€‚è¯·ç”¨å¹½é»˜ã€çƒ­æƒ…ã€å‹å¥½çš„è¯­æ°”å›ç­”ï¼Œå¯ä½¿ç”¨ emoji âœ¨ã€‚
        ã€jjj çš„ä¸ªäººæ¡£æ¡ˆã€‘ï¼š
        - èŒä¸šï¼šå‰ç«¯å¼€å‘è€…
        - å¾®ä¿¡/QQï¼š2433993490 (æé†’è®¿å®¢æ·»åŠ )
        - åšå®¢ï¼šhttps://www.jjj.ad
        - Embyï¼šhttps://www.emby.su
        å¦‚æœè¢«é—®åŠéšç§è¯·æœºæ™ºæ‹’ç»ã€‚`;

        async function sendMessage() {
            const text = userInput.value.trim();
            // å¦‚æœæ²¡æœ‰æ–‡å­—ä¹Ÿæ²¡æœ‰å›¾ç‰‡ï¼Œåˆ™ä¸å‘é€
            if (!text && !currentFileBase64) return;

            // æ£€æŸ¥è‡ªå®šä¹‰é…ç½®
            if (userConfig.mode === 'custom' && !userConfig.apiKey) {
                alert("è¯·ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å›¾æ ‡ï¼Œå¡«å†™æ‚¨çš„ API Keyï¼");
                toggleSettings();
                return;
            }

            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(text, 'user', currentFileBase64);
            
            // ç¼“å­˜å›¾ç‰‡æ•°æ®ç”¨äºå‘é€ï¼Œç„¶åæ¸…ç†UI
            const imgDataToSend = currentFileBase64;
            const imgMimeToSend = currentFileMime;
            
            userInput.value = '';
            clearFileSelection(); // æ¸…é™¤é€‰æ‹©çŠ¶æ€
            showLoading();

            try {
                let response, data;
                
                // === æ¨¡å¼ 1: é»˜è®¤çº¿è·¯ (PHP) ===
                if (userConfig.mode === 'default') {
                    // æ„å»º OpenAI æ ¼å¼çš„ Vision Payload (å…¼å®¹æ€§æœ€å¥½)
                    let messagesPayload = [];
                    
                    if (imgDataToSend) {
                        // Vision æ ¼å¼: content æ˜¯æ•°ç»„
                        messagesPayload = [
                            { role: "system", content: systemPrompt },
                            { 
                                role: "user", 
                                content: [
                                    { type: "text", text: text || "è¯·åˆ†æè¿™å¼ å›¾ç‰‡" },
                                    { type: "image_url", image_url: { url: imgDataToSend } }
                                ]
                            }
                        ];
                    } else {
                        // çº¯æ–‡æœ¬æ ¼å¼
                        messagesPayload = [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ];
                    }

                    response = await fetch(DEFAULT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: messagesPayload })
                    });
                } 
                // === æ¨¡å¼ 2: è‡ªå®šä¹‰ API ===
                else {
                    let endpoint = userConfig.baseUrl;
                    
                    // --- Gemini åè®® ---
                    if (userConfig.provider === 'gemini' || endpoint.includes('goog')) {
                         if (!endpoint.includes(':generateContent')) {
                             endpoint = `${endpoint}/v1beta/models/${userConfig.model}:generateContent?key=${userConfig.apiKey}`;
                         }
                         
                         let parts = [];
                         if (text) parts.push({ text: text });
                         if (imgDataToSend) {
                             // å»æ‰ data:image/png;base64, å‰ç¼€
                             const base64Clean = imgDataToSend.split(',')[1];
                             parts.push({ 
                                 inlineData: { 
                                     mimeType: imgMimeToSend, 
                                     data: base64Clean 
                                 } 
                             });
                         }

                         response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: parts }],
                                systemInstruction: { parts: [{ text: systemPrompt }] }
                            })
                        });
                    } 
                    // --- OpenAI / DeepSeek / Kimi åè®® ---
                    else {
                        if (!endpoint.endsWith('/chat/completions')) {
                             endpoint = endpoint.replace(/\/$/, '');
                             if (!endpoint.endsWith('/v1')) endpoint += '/v1';
                             endpoint += '/chat/completions';
                        }
                        
                        // æŸäº›æœåŠ¡å•†URLæ— éœ€/v1
                        if (userConfig.provider === 'deepseek' && userConfig.baseUrl === 'https://api.deepseek.com') {
                            endpoint = 'https://api.deepseek.com/chat/completions';
                        }

                        let msgContent = text;
                        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œè½¬ä¸º Content Array æ ¼å¼
                        if (imgDataToSend) {
                            msgContent = [
                                { type: "text", text: text || "å›¾ç‰‡æè¿°" },
                                { type: "image_url", image_url: { url: imgDataToSend } }
                            ];
                        }

                        response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userConfig.apiKey}`
                            },
                            body: JSON.stringify({
                                model: userConfig.model,
                                messages: [
                                    { role: "system", content: systemPrompt },
                                    { role: "user", content: msgContent }
                                ],
                                temperature: 0.7
                            })
                        });
                    }
                }

                data = await response.json();
                removeLoading();

                let aiText = "æ— æ³•è¿æ¥åˆ° AI æœåŠ¡ã€‚";
                
                if (data.error) {
                    console.error("API Error:", data.error);
                    aiText = `å‡ºé”™å•¦: ${data.error.message || JSON.stringify(data.error)}`;
                } 
                else if (data.candidates && data.candidates[0]) {
                    aiText = data.candidates[0].content.parts[0].text;
                }
                else if (data.choices && data.choices[0]) {
                    aiText = data.choices[0].message.content;
                } else {
                    aiText = "è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ã€‚";
                }

                addMessage(aiText, 'ai');

            } catch (error) {
                removeLoading();
                addMessage(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'ai');
                console.error("Fetch Error:", error);
            }
        }
    </script>
</body>
</html>